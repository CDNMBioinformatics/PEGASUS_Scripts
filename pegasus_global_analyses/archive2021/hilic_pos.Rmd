---
title: "PEGASUS new global metabolomics"
subtitle: "HILIC positive"
author: "MHuang"
date: "9/22/2020"
output: 
  html_document: 
    toc: yes
    toc_float: 
      collapsed: false
      smooth_scroll: false
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}

## Packages

pkg <- c("tidyverse", "data.table", "here", "survival", "gtools", "DT", "table1")
for (p in pkg) {
        if (require(p, character.only = T)) {
                print(paste0(p, " loaded successfully"))
        } else {
                install.packages(p)
                require(p, character.only = T)
                print(paste0(p, " downloaded and loaded successfully"))
        }
}


## Paths

met_dir <- "C:/Users/MHuang/Dropbox (Partners HealthCare)/PEGASUS/global_metabolomics_082020/pegasus_global_data_qc/post_qc_data/"
pheno_dir <- "C:/Users/MHuang/Dropbox (Partners HealthCare)/PEGASUS/rpdr_data/rpdr_data_wrangling/data/"
dat_dir <- "data/"
fig_dir <- "figures/"
res_dir <- "results/hilic_pos/"


## Filenames

all_subj_fname <- str_c(pheno_dir, "all_subj_enc_bmi.csv")
med_cs_fname <- str_c(pheno_dir, "med_corticosteroids_summary.csv")
wbc_fname <- str_c(pheno_dir, "wbc_count_closest_to_serum_collection.csv")
exac_fname <- str_c(pheno_dir, "asthma_exacerbation_summary.csv")
comorb_fname <- str_c(pheno_dir, "comorbidities_of_interest.csv")
pft_fname <- str_c(pheno_dir, "pft_prebronchodilator_closest_to_serum_collection.csv")
ige_fname <- str_c(pheno_dir, "ige_closest_to_serum_collection.csv")
allergy_fname <- str_c(pheno_dir, "ige_high_env_allergy_ever.csv")
hilic_pos_fname <- str_c(met_dir, "hilic_pos/outlier_checked/processed_hilic_pos_halfmin.RData")


## Hard-coded numbers

missing_thld <- 0.30
sig_digits <- 3
alpha_thld <- 0.05
z_95 <- qnorm(p = 0.975)
num_cols <- c("beta", "pval", "fdr_bh", "or", "lower95", "upper95", "pct_na_met", "cv")

```

# 1. Data assembly
## 1.1. Phenotype/EMR data

```{r}

all_subj <- fread(all_subj_fname)
all_subj[, Collect_Date := as.Date(Collect_Date, format = "%Y-%m-%d")]
all_subj[, .N, .(is.na(EMPI), is.na(Collect_Date))][order(is.na, is.na.1)] %>% 
        setnames(., c("missing_EMPI", "missing_Collect_Date", "N")) %>% print()
all_subj[, asthma_num := case_when(Asthma_Status == TRUE ~ 1, 
                                   Asthma_Status == FALSE ~ 0)]

med_cs <- fread(med_cs_fname)
pheno <- merge(all_subj[!is.na(EMPI), ], med_cs, by = c("EMPI", "SampleGroup"), all.x = T)

comorb <- fread(comorb_fname)
pheno <- merge(pheno, comorb[!is.na(EMPI), ], by = c("EMPI"), all.x = T)

wbc <- fread(wbc_fname)
pheno <- merge(pheno, wbc, by = c("EMPI"), all.x = T)

exac <- fread(exac_fname)
pheno <- merge(pheno, exac, by = c("EMPI", "SampleGroup"), all.x = T)

pft <- fread(pft_fname)
pheno <- merge(pheno, pft, by = c("EMPI", "SampleGroup"), all.x = T)

ige <- fread(ige_fname)
pheno <- merge(pheno, ige, by = c("EMPI"), all.x = T)

allergy <- fread(allergy_fname)
pheno <- merge(pheno, allergy, by = c("EMPI"), all.x = T)

pheno[, ':='(race = case_when(Race %in% c("White", "Black") ~ Race, 
                              TRUE ~ "Other"), 
             fev1fvc_prebd_pctpred = fev1_prebd_pctpred / fvc_prebd_pctpred)]

save(pheno, file = here(dat_dir, "pheno.RData"))

```

## 1.2. HILIC-positive halfmin imputed data (outlier checked)

```{r}

load(hilic_pos_fname, verbose = T)
hilic_pos_dat <- merge(pheno, samp_dat_final, by = c("sampleID_biobank", "SampleGroup", "Match_ID", 
                                                     "Asthma_Status", "Age", "Gender", "Race", "BMI", "Nonsmoker"))
hilic_pos_mets_info <- copy(mets_info)


## Manually annotate cortisol (F1381, confirmed with standard by Pei)

hilic_pos_mets_info[feature == "F1381", tentative_annotation := "Cortisol"]


## Add indicators for platform, medication & without MS2

hilic_pos_mets_info[, platform := "HILIC-pos"]

meds_string <- str_c("Flutrimazole|Bezafibrate|Esomeprazole|Levocetirizine|Paracetamol|Irbesartan|",
                     "Gabapentin|Fexofenadine|Isosorbide|Lisofylline|Venlafaxine|Nortriptyline|Metformin|", 
                     "Escitalopram|Methocarbamol|Dantrolene|Trimethoprim|Sulfamethoxazole|Thioguanine|", 
                     "Thalidomide|Diazepam|Trazodone|Levetiracetam|Diltiazem|Fenoterol|Eflornithine|", 
                     "Carbetapentane|Fluoxetine|Fluconazole|Metronidazole|Valsartan|Warfarin")

hilic_pos_mets_info[tentative_annotation != "Unknown", 
                    ':='(wo_ms2 = case_when(grepl("(?i)w/o ms2", tentative_annotation) ~ 1, 
                                            TRUE ~ 0), 
                         med_feat = case_when(grepl(meds_string, tentative_annotation, ignore.case = T) ~ 1, 
                                              TRUE ~ 0))]


## Remove original metabolomic data files with non-specific names

rm(mets_info, samp_dat_final, samp_dat_origscale, samp_na, samp_mets_cols)
save(hilic_pos_dat, hilic_pos_mets_info, file = here(dat_dir, "hilic_pos_data_updated.RData"))

```

## 1.3. Apply exclusion

 - _trim: subjects missing collection date / bmi / bmi >5yrs away from collection date & matched subjects removed  
 - _excl: further excluded subjects with the following comorbidities and matched subjects  
     - COPD, A1AD, cystic fibrosis, bronchiectasis, chronic bronchitis, immuno deficiency

```{r}

stratum_to_rm <- hilic_pos_dat[is.na(Collect_Date) | is.na(bmi) | abs(bmi_timegap_y) > 5, unique(Stratum)]
stratum_to_rm <- c(stratum_to_rm, hilic_pos_dat[, .N, Stratum][N == 1, Stratum]); length(stratum_to_rm)
hilic_pos_dat_trim <- hilic_pos_dat[!(Stratum %in% stratum_to_rm), ]

hilic_pos_dat_trim[, .N, .(ocs_ard_serum_coll, cortisone_ard_serum_coll, SampleGroup, asthma_num, 
                           Asthma_Status)][order(asthma_num, ocs_ard_serum_coll)]
hilic_pos_dat_trim[, .N, .(copd_5, a1ad, cf, bronchiectasis, cbronchitis, immunodef, asthma_num)][order(asthma_num)]
comorb_excl <- hilic_pos_dat_trim[copd_5 == 1 | a1ad == 1 | cf == 1 | bronchiectasis == 1 | cbronchitis == 1 | 
                                    immunodef == 1, unique(Stratum)]; length(comorb_excl)
hilic_pos_dat_excl <- hilic_pos_dat_trim[!(Stratum %in% comorb_excl), ]

```

## 1.4. Table 1
### 1.4.1. trim dataset

```{r}

table1( ~ Age + bmi + Gender + Race + Ethnicity + Nonsmoker | SampleGroup, data = hilic_pos_dat_trim)
table1( ~ ics_trim_totnum_1y + ocs_trim_totnum_1y + eos + neut + asthma_exacerbation_trim_totnum_1y + 
          fev1_prebd_pctpred + fvc_prebd_pctpred + log10(ige) | SampleGroup, data = hilic_pos_dat_trim)

```

### 1.4.1. excl dataset

```{r}

table1( ~ Age + bmi + Gender + Race + Ethnicity + Nonsmoker | SampleGroup, data = hilic_pos_dat_excl)
table1( ~ ics_trim_totnum_1y + ocs_trim_totnum_1y + eos + neut + asthma_exacerbation_trim_totnum_1y + 
          fev1_prebd_pctpred + fvc_prebd_pctpred + log10(ige) | SampleGroup, data = hilic_pos_dat_excl)

```

# 2. Regression model functions

On features that passed QC with <= 30% missing

```{r}

feat_list <- hilic_pos_mets_info[is.na(qc_rm) & pct_na_met <= missing_thld, feature]; length(feat_list)

clogi_res_fnc <- function(outc, mets_list, dat, mets_info, add_covar = "", 
                          first_cols = c("feature", "beta", "pval", "fdr_bh", "tentative_annotation", 
                                         "wo_ms2", "med_feat", "rt_min", "mz", "platform", "or", 
                                         "lower95", "upper95", "totaln", "casen", "cv", "pct_na_met"), 
                          na_thld = missing_thld) {
        
        clogi_mdl_tmp <- function(met) {
                
                fit <- eval(parse(text = str_c("clogit(", outc, " ~ ", met, " + strata(Stratum)", 
                                               add_covar, ", data = ", dat, ")")))
                
                coef <- summary(fit)$coefficients
                coef <- coef[rownames(coef) == met, ]
                
                confint <- summary(fit)$conf.int
                confint <- confint[rownames(confint) == met, -c(1:2)]
                
                totaln <- summary(fit)$n
                casen <- summary(fit)$nevent
                
                output <- t(c(outc, met, coef, confint, totaln, casen)) %>% as.data.table()
                colnames(output) <- c("outc", "feature", "beta", "or", "se", "zval", "pval", 
                                      "lower95", "upper95", "totaln", "casen")
                output[, (colnames(output)[-c(1:2)]) := lapply(.SD, as.numeric), .SDcols = colnames(output)[-c(1:2)]]
                
                return(output)
        }
        
        res <- lapply(mets_list, function(x) {clogi_mdl_tmp(met = x)}) %>% rbindlist()
        
        eval(parse(text = str_c("mets_info <- copy(", mets_info, ")")))
        res <- merge(res, 
                     mets_info[, .(feature, rt_min, mz, tentative_annotation, wo_ms2, med_feat, 
                                   platform, cv, pct_na_met, skewness_post)], 
                     by = "feature")
        res[pct_na_met <= na_thld & feature != "Unknown", fdr_bh := p.adjust(pval, method = "BH")] 
        
        setcolorder(res, first_cols)
        res <- res[order(pval)]
        return(res)
}

linreg_res_fnc <- function(expo, mets_list, dat, mets_info, add_covar = "", 
                           first_cols = c("feature", "expo_linreg", "beta_linreg", "pval_linreg", 
                                          "fdr_bh_linreg", "tentative_annotation", "wo_ms2", "med_feat", 
                                          "rt_min", "mz", "platform", "cv", "pct_na_met"), 
                           na_thld = missing_thld) {
        
        linear_mdl_tmp <- function(met) {
                
                fit <- eval(parse(text = str_c("lm(", met, " ~ ", expo, " + Age + race", 
                                               add_covar, ", data = ", dat, ")")))
                
                coef <- summary(fit)$coefficients
                coef <- coef[rownames(coef) == expo, ]

                output <- t(c(expo, met, coef)) %>% as.data.table()
                colnames(output) <- c("expo_linreg", "feature", "beta_linreg", "se_linreg", "tval_linreg", 
                                      "pval_linreg")
                output[, (colnames(output)[-c(1:2)]) := lapply(.SD, as.numeric), .SDcols = colnames(output)[-c(1:2)]]
                
                return(output)
        }
        
        res <- lapply(mets_list, function(x) {linear_mdl_tmp(met = x)}) %>% rbindlist()
        
        eval(parse(text = str_c("mets_info <- copy(", mets_info, ")")))
        res <- merge(res, 
                     mets_info[, .(feature, rt_min, mz, tentative_annotation, wo_ms2, med_feat, 
                                   platform, cv, pct_na_met, skewness_post)], 
                     by = "feature")
        res[pct_na_met <= na_thld & feature != "Unknown", fdr_bh_linreg := p.adjust(pval_linreg, method = "BH")] 
        
        setcolorder(res, first_cols)
        res <- res[order(pval_linreg)]
        return(res)
}

```

# 3. Analyses accounting for matched strata
## 3.1. Compare excluding OCS around serum collection vs not
### 3.1.1. NOT excluding COPD, cystic fibrosis, bronchiectasis, chronic bronchitis, a1ad, immune deficiencies

```{r}

res_3_1_1_1 <- clogi_res_fnc(outc = "asthma_num", 
                             mets_list = feat_list, 
                             dat = "hilic_pos_dat_trim", 
                             mets_info = "hilic_pos_mets_info", 
                             add_covar = " + bmi")
# datatable(res_3_1_1_1[tentative_annotation != "Unknown"], filter = "top") %>% 
#         formatSignif(columns = num_cols, digits = sig_digits)

dat_tmp <- hilic_pos_dat_trim[Stratum %in% hilic_pos_dat_trim[ocs_ard_serum_coll == 0, Stratum], ]
res_3_1_1_2 <- clogi_res_fnc(outc = "asthma_num", 
                             mets_list = feat_list, 
                             dat = "dat_tmp", 
                             mets_info = "hilic_pos_mets_info", 
                             add_covar = " + bmi")
# datatable(res_3_1_1_2[tentative_annotation != "Unknown"], filter = "top") %>% 
#         formatSignif(columns = num_cols, digits = sig_digits)

res_3_1_1_1[tentative_annotation != "Unknown" & pval < alpha_thld/5, .N, 
         feature %in% res_3_1_1_2[tentative_annotation != "Unknown" & pval < alpha_thld/5, feature]]
res_3_1_1_2[tentative_annotation != "Unknown" & pval < alpha_thld/5, .N, 
         feature %in% res_3_1_1_1[tentative_annotation != "Unknown" & pval < alpha_thld/5, feature]]

```

### 3.1.2. Excluding COPD, cystic fibrosis, bronchiectasis, chronic bronchitis, a1ad, immune deficiencies

```{r}

res_3_1_2_1 <- clogi_res_fnc(outc = "asthma_num", 
                             mets_list = feat_list, 
                             dat = "hilic_pos_dat_excl", 
                             mets_info = "hilic_pos_mets_info", 
                             add_covar = " + bmi")
# datatable(res_3_1_2_1[tentative_annotation != "Unknown"], filter = "top") %>% 
#         formatSignif(columns = num_cols, digits = sig_digits)

dat_tmp <- hilic_pos_dat_excl[Stratum %in% hilic_pos_dat_excl[ocs_ard_serum_coll == 0, Stratum], ]
res_3_1_2_2 <- clogi_res_fnc(outc = "asthma_num", 
                             mets_list = feat_list, 
                             dat = "dat_tmp", 
                             mets_info = "hilic_pos_mets_info", 
                             add_covar = " + bmi")
# datatable(res_3_1_2_2[tentative_annotation != "Unknown"], filter = "top") %>% 
#         formatSignif(columns = num_cols, digits = sig_digits)

res_3_1_2_1[tentative_annotation != "Unknown" & pval < alpha_thld/5, .N, 
         feature %in% res_3_1_2_2[tentative_annotation != "Unknown" & pval < alpha_thld/5, feature]]
res_3_1_2_2[tentative_annotation != "Unknown" & pval < alpha_thld/5, .N, 
         feature %in% res_3_1_2_1[tentative_annotation != "Unknown" & pval < alpha_thld/5, feature]]

```

> Conclusion: excluding asthmatics with OCS within 10 days of serum collection made a small amount of differences 
in the number of annotated metabolites with p<0.01; will proceed without the exclusion

## 3.2. Compare excluding certain comorbidities vs not

Comorbidities excluded here: COPD, cystic fibrosis, bronchiectasis, chronic bronchitis, a1ad, immune deficiencies

```{r}

res_3_1_1_1[tentative_annotation != "Unknown" & pval < alpha_thld/5, .N, 
         feature %in% res_3_1_2_1[tentative_annotation != "Unknown" & pval < alpha_thld/5, feature]]
res_3_1_2_1[tentative_annotation != "Unknown" & pval < alpha_thld/5, .N, 
         feature %in% res_3_1_1_1[tentative_annotation != "Unknown" & pval < alpha_thld/5, feature]]

datatable(res_3_1_1_1[tentative_annotation != "Unknown"], filter = "top") %>%
        formatSignif(columns = num_cols, digits = sig_digits)
datatable(res_3_1_2_1[tentative_annotation != "Unknown"], filter = "top") %>%
        formatSignif(columns = num_cols, digits = sig_digits)

```

> Conclusion: will proceed with excluding these conditions (res_3_1_2_1)

## 3.3. Adjusted for BMI & certain comorbities

Excluding COPD, cystic fibrosis, bronchiectasis, chronic bronchitis, alpha-1-antitrypsin deficiency, and immune deficiencies
Adjusting for pulmonary hypertension, allergic rhinitis, congestive heart failure, gerd

```{r}

res_3_3 <- clogi_res_fnc(outc = "asthma_num", 
                         mets_list = feat_list, 
                         dat = "hilic_pos_dat_excl", 
                         mets_info = "hilic_pos_mets_info", 
                         add_covar = " + bmi + pulhtn + arhinitis + chf + gerd")

res_3_1_2_1[tentative_annotation != "Unknown" & pval < alpha_thld/5, .N, 
         feature %in% res_3_3[tentative_annotation != "Unknown" & pval < alpha_thld/5, feature]]
res_3_3[tentative_annotation != "Unknown" & pval < alpha_thld/5, .N, 
         feature %in% res_3_1_2_1[tentative_annotation != "Unknown" & pval < alpha_thld/5, feature]]

```

> Conclusion: will proceed with not adjusting for pulmonary hypertension, allergic rhinitis, congestive heart failure, gerd

# 4. Association with ICS # prescriptions in all asthmatics

```{r}

dat_tmp <- hilic_pos_dat_excl[asthma_num == 1, ]
ggplot(dat_tmp) + geom_histogram(aes(ics_trim_totnum_1y), bins = 30)
# dat_tmp[, ics_trim_totnum_1y_ind := case_when(ics_trim_totnum_1y == 0 ~ 0, 
#                                               ics_trim_totnum_1y > 1 ~ 1)]
res_ics <- linreg_res_fnc(expo = "ics_trim_totnum_1y", 
                          mets_list = feat_list, 
                          dat = "dat_tmp", 
                          mets_info = "hilic_pos_mets_info", 
                          add_covar = " + Gender + bmi")

res_overall <- merge(res_3_1_2_1, 
                     res_ics[, .(feature, expo_linreg, beta_linreg, pval_linreg, fdr_bh_linreg)], 
                     by = "feature")
res_overall <- res_overall[order(pval)][, subgroup := "overall"] %>% setcolorder(., "subgroup")

display_cols <- c("subgroup", "feature", "tentative_annotation", "med_feat", "platform", "beta", "pval", "fdr_bh", 
                  "or", "lower95", "upper95", "expo_linreg", "beta_linreg", "pval_linreg", "fdr_bh_linreg")
datatable(res_overall[tentative_annotation != "Unknown", ..display_cols], filter = "top") %>% 
        formatSignif(columns = c("beta", "pval", "fdr_bh", "or", "lower95", "upper95", 
                                 "beta_linreg", "pval_linreg", "fdr_bh_linreg"), digits = sig_digits)


## Save results

saveRDS(res_overall, file = here(res_dir, "res_overall_hilic_pos.rds"))

```

# 5. Subgroup analyses
## 5.1. Subgroup by gender
### 5.1.1. Female

```{r}

## Asthmatics vs controls

dat_tmp1 <- hilic_pos_dat_excl[Gender == "F", ]
res_5_1_1 <- clogi_res_fnc(outc = "asthma_num", 
                           mets_list = feat_list, 
                           dat = "dat_tmp1", 
                           mets_info = "hilic_pos_mets_info", 
                           add_covar = " + bmi")
res_5_1_1[tentative_annotation != "Unknown" & pval < alpha_thld/5, .N, 
          feature %in% res_overall[tentative_annotation != "Unknown" & pval < alpha_thld/5, feature]]
res_5_1_1 <- res_5_1_1[, subgroup := "female"] %>% setcolorder(., "subgroup")


## Association with ICS # prescription in asthmatics

dat_tmp2 <- hilic_pos_dat_excl[Gender == "F" & asthma_num == 1, ]
res_5_1_1_ics <- linreg_res_fnc(expo = "ics_trim_totnum_1y", 
                                mets_list = feat_list, 
                                dat = "dat_tmp2", 
                                mets_info = "hilic_pos_mets_info", 
                                add_covar = " + bmi")
res_female <- merge(res_5_1_1, 
                    res_5_1_1_ics[, .(feature, expo_linreg, beta_linreg, pval_linreg, fdr_bh_linreg)], 
                    by = "feature")


## Save results

saveRDS(res_female, file = here(res_dir, "res_female_hilic_pos.rds"))

```

### 5.1.2. Male

```{r}

## Asthmatics vs controls

dat_tmp1 <- hilic_pos_dat_excl[Gender == 'M', ]
res_5_1_2 <- clogi_res_fnc(outc = "asthma_num", 
                           mets_list = feat_list, 
                           dat = "dat_tmp1", 
                           mets_info = "hilic_pos_mets_info", 
                           add_covar = " + bmi")
res_5_1_2[tentative_annotation != "Unknown" & pval < alpha_thld/5, .N, 
          feature %in% res_3_1_2_1[tentative_annotation != "Unknown" & pval < alpha_thld/5, feature]]
res_5_1_2 <- res_5_1_2[, subgroup := "male"] %>% setcolorder(., "subgroup")


## Association with ICS # prescription in asthmatics

dat_tmp2 <- hilic_pos_dat_excl[Gender == "M" & asthma_num == 1, ]
res_5_1_2_ics <- linreg_res_fnc(expo = "ics_trim_totnum_1y", 
                                mets_list = feat_list, 
                                dat = "dat_tmp2", 
                                mets_info = "hilic_pos_mets_info", 
                                add_covar = " + bmi")
res_male <- merge(res_5_1_2, 
                  res_5_1_2_ics[, .(feature, expo_linreg, beta_linreg, pval_linreg, fdr_bh_linreg)], 
                  by = "feature")


## Save results

saveRDS(res_male, file = here(res_dir, "res_male_hilic_pos.rds"))

```

## 5.2. Subgroup by ICS use in 1 year before collection
### 5.2.1. ICS # prescription > 0

```{r}

## Asthmatics vs controls

dat_tmp1 <- hilic_pos_dat_excl[Stratum %in% hilic_pos_dat_excl[asthma_num == 1 & ics_trim_totnum_1y > 0, Stratum], ]
res_5_2_1 <- clogi_res_fnc(outc = "asthma_num", 
                           mets_list = feat_list, 
                           dat = "dat_tmp1", 
                           mets_info = "hilic_pos_mets_info", 
                           add_covar = " + bmi")
res_5_2_1[tentative_annotation != "Unknown" & pval < alpha_thld/5, .N, 
          feature %in% res_overall[tentative_annotation != "Unknown" & pval < alpha_thld/5, feature]]
res_5_2_1 <- res_5_2_1[, subgroup := "ics_1y_prior_yes"] %>% setcolorder(., "subgroup")


## Association with ICS # prescription in asthmatics

dat_tmp2 <- hilic_pos_dat_excl[ics_trim_totnum_1y > 0 & asthma_num == 1, ]
res_5_2_1_ics <- linreg_res_fnc(expo = "ics_trim_totnum_1y", 
                                mets_list = feat_list, 
                                dat = "dat_tmp2", 
                                mets_info = "hilic_pos_mets_info", 
                                add_covar = " + Gender + bmi")
res_ics_1y_y <- merge(res_5_2_1, 
                      res_5_2_1_ics[, .(feature, expo_linreg, beta_linreg, pval_linreg, fdr_bh_linreg)], 
                      by = "feature")


## Save results

saveRDS(res_ics_1y_y, file = here(res_dir, "res_ics_1y_y_hilic_pos.rds"))

```

### 5.2.2. ICS # prescription == 0

```{r}

## Asthmatics vs controls

dat_tmp1 <- hilic_pos_dat_excl[Stratum %in% hilic_pos_dat_excl[asthma_num == 1 & ics_trim_totnum_1y == 0, Stratum], ]
res_5_2_2 <- clogi_res_fnc(outc = "asthma_num", 
                           mets_list = feat_list, 
                           dat = "dat_tmp1", 
                           mets_info = "hilic_pos_mets_info", 
                           add_covar = " + bmi")
res_5_2_2[tentative_annotation != "Unknown" & pval < alpha_thld/5, .N, 
          feature %in% res_overall[tentative_annotation != "Unknown" & pval < alpha_thld/5, feature]]
res_5_2_2 <- res_5_2_2[, subgroup := "ics_1y_prior_no"] %>% setcolorder(., "subgroup")


## Save results

res_ics_1y_n <- res_5_2_2[, ':='(expo_linreg = NA, beta_linreg = NA, pval_linreg = NA, fdr_bh_linreg = NA)]
saveRDS(res_ics_1y_n, file = here(res_dir, "res_ics_1y_n_hilic_pos.rds"))

```

## 5.3. Subgroup by eosinophil count
### 5.3.1. EOS >= 0.3 K/uL

```{r}

## Asthmatics vs controls

dat_tmp1 <- hilic_pos_dat_excl[Stratum %in% hilic_pos_dat_excl[asthma_num == 1 & eos >= 0.3, Stratum], ]
res_5_3_1 <- clogi_res_fnc(outc = "asthma_num", 
                           mets_list = feat_list, 
                           dat = "dat_tmp1", 
                           mets_info = "hilic_pos_mets_info", 
                           add_covar = " + bmi")
res_5_3_1[tentative_annotation != "Unknown" & pval < alpha_thld/5, .N, 
          feature %in% res_overall[tentative_annotation != "Unknown" & pval < alpha_thld/5, feature]]
res_5_3_1 <- res_5_3_1[, subgroup := "eos_high_300"] %>% setcolorder(., "subgroup")


## Association with ICS # prescription in asthmatics

dat_tmp2 <- hilic_pos_dat_excl[asthma_num == 1 & eos >= 0.3, ]
res_5_3_1_ics <- linreg_res_fnc(expo = "ics_trim_totnum_1y", 
                                mets_list = feat_list, 
                                dat = "dat_tmp2", 
                                mets_info = "hilic_pos_mets_info", 
                                add_covar = " + Gender + bmi")
res_eos_high <- merge(res_5_3_1, 
                      res_5_3_1_ics[, .(feature, expo_linreg, beta_linreg, pval_linreg, fdr_bh_linreg)], 
                      by = "feature")


## Save results

saveRDS(res_eos_high, file = here(res_dir, "res_eos_high_hilic_pos.rds"))

```

### 5.3.2. EOS < 0.3 K/uL

```{r}

## Asthmatics vs controls

dat_tmp1 <- hilic_pos_dat_excl[Stratum %in% hilic_pos_dat_excl[asthma_num == 1 & eos < 0.3, Stratum], ]
res_5_3_2 <- clogi_res_fnc(outc = "asthma_num", 
                           mets_list = feat_list, 
                           dat = "dat_tmp1", 
                           mets_info = "hilic_pos_mets_info", 
                           add_covar = " + bmi")
res_5_3_2[tentative_annotation != "Unknown" & pval < alpha_thld/5, .N, 
          feature %in% res_overall[tentative_annotation != "Unknown" & pval < alpha_thld/5, feature]]
res_5_3_2 <- res_5_3_2[, subgroup := "eos_low_300"] %>% setcolorder(., "subgroup")


## Association with ICS # prescription in asthmatics

dat_tmp2 <- hilic_pos_dat_excl[asthma_num == 1 & eos < 0.3, ]
res_5_3_2_ics <- linreg_res_fnc(expo = "ics_trim_totnum_1y", 
                                mets_list = feat_list, 
                                dat = "dat_tmp2", 
                                mets_info = "hilic_pos_mets_info", 
                                add_covar = " + Gender + bmi")
res_eos_low <- merge(res_5_3_2, 
                     res_5_3_2_ics[, .(feature, expo_linreg, beta_linreg, pval_linreg, fdr_bh_linreg)], 
                     by = "feature")


## Save results

saveRDS(res_eos_low, file = here(res_dir, "res_eos_low_hilic_pos.rds"))

```

## 5.4. Subgroup by asthma exacerbation == 0 in 1 year before collection
### 5.4.1. Exacerbation count > 0

```{r}

## Asthmatics vs controls

dat_tmp1 <- hilic_pos_dat_excl[Stratum %in% hilic_pos_dat_excl[asthma_num == 1 & 
                                                                 asthma_exacerbation_trim_totnum_1y > 0, Stratum], ]
res_5_4_1 <- clogi_res_fnc(outc = "asthma_num", 
                           mets_list = feat_list, 
                           dat = "dat_tmp1", 
                           mets_info = "hilic_pos_mets_info", 
                           add_covar = " + bmi")
res_5_4_1[tentative_annotation != "Unknown" & pval < alpha_thld/5, .N, 
          feature %in% res_overall[tentative_annotation != "Unknown" & pval < alpha_thld/5, feature]]
res_5_4_1 <- res_5_4_1[, subgroup := "exacerbation_1y_prior_yes"] %>% setcolorder(., "subgroup")


## Association with ICS # prescription in asthmatics

dat_tmp2 <- hilic_pos_dat_excl[asthma_num == 1 & asthma_exacerbation_trim_totnum_1y > 0, ]
res_5_4_1_ics <- linreg_res_fnc(expo = "ics_trim_totnum_1y", 
                                mets_list = feat_list, 
                                dat = "dat_tmp2", 
                                mets_info = "hilic_pos_mets_info", 
                                add_covar = " + Gender + bmi")
res_exac_1y_y <- merge(res_5_4_1, 
                       res_5_4_1_ics[, .(feature, expo_linreg, beta_linreg, pval_linreg, fdr_bh_linreg)], 
                       by = "feature")


## Save results

saveRDS(res_exac_1y_y, file = here(res_dir, "res_exac_1y_y_hilic_pos.rds"))

```

### 5.4.2. Exacerbation count == 0

```{r}

## Asthmatics vs controls

dat_tmp1 <- hilic_pos_dat_excl[Stratum %in% hilic_pos_dat_excl[asthma_num == 1 & 
                                                                 asthma_exacerbation_trim_totnum_1y == 0, Stratum], ]
res_5_4_2 <- clogi_res_fnc(outc = "asthma_num", 
                           mets_list = feat_list, 
                           dat = "dat_tmp1", 
                           mets_info = "hilic_pos_mets_info", 
                           add_covar = " + bmi")
res_5_4_2[tentative_annotation != "Unknown" & pval < alpha_thld/5, .N, 
          feature %in% res_overall[tentative_annotation != "Unknown" & pval < alpha_thld/5, feature]]
res_5_4_2 <- res_5_4_2[, subgroup := "exacerbation_1y_prior_no"] %>% setcolorder(., "subgroup")


## Association with ICS # prescription in asthmatics

dat_tmp2 <- hilic_pos_dat_excl[asthma_num == 1 & asthma_exacerbation_trim_totnum_1y == 0, ]
res_5_4_2_ics <- linreg_res_fnc(expo = "ics_trim_totnum_1y", 
                                mets_list = feat_list, 
                                dat = "dat_tmp2", 
                                mets_info = "hilic_pos_mets_info", 
                                add_covar = " + Gender + bmi")
res_exac_1y_n <- merge(res_5_4_2, 
                       res_5_4_2_ics[, .(feature, expo_linreg, beta_linreg, pval_linreg, fdr_bh_linreg)], 
                       by = "feature")


## Save results

saveRDS(res_exac_1y_n, file = here(res_dir, "res_exac_1y_n_hilic_pos.rds"))

```

## 5.5. Subgroup by obesity
### 5.5.1. BMI >= 30

```{r}

## Asthmatics vs controls

dat_tmp1 <- hilic_pos_dat_excl[Stratum %in% hilic_pos_dat_excl[asthma_num == 1 & bmi >= 30, Stratum], ]
res_5_5_1 <- clogi_res_fnc(outc = "asthma_num", 
                           mets_list = feat_list, 
                           dat = "dat_tmp1", 
                           mets_info = "hilic_pos_mets_info", 
                           add_covar = " + bmi")
res_5_5_1[tentative_annotation != "Unknown" & pval < alpha_thld/5, .N, 
          feature %in% res_overall[tentative_annotation != "Unknown" & pval < alpha_thld/5, feature]]
res_5_5_1 <- res_5_5_1[, subgroup := "bmi_high_30"] %>% setcolorder(., "subgroup")


## Association with ICS # prescription in asthmatics

dat_tmp2 <- hilic_pos_dat_excl[asthma_num == 1 & bmi >= 30, ]
res_5_5_1_ics <- linreg_res_fnc(expo = "ics_trim_totnum_1y", 
                                mets_list = feat_list, 
                                dat = "dat_tmp2", 
                                mets_info = "hilic_pos_mets_info", 
                                add_covar = " + Gender + bmi")
res_bmi_high <- merge(res_5_5_1, 
                      res_5_5_1_ics[, .(feature, expo_linreg, beta_linreg, pval_linreg, fdr_bh_linreg)], 
                      by = "feature")


## Save results

saveRDS(res_bmi_high, file = here(res_dir, "res_bmi_high_hilic_pos.rds"))

```

### 5.5.2. BMI < 30

```{r}

## Asthmatics vs controls

dat_tmp1 <- hilic_pos_dat_excl[Stratum %in% hilic_pos_dat_excl[asthma_num == 1 & bmi < 30, Stratum], ]
res_5_5_2 <- clogi_res_fnc(outc = "asthma_num", 
                           mets_list = feat_list, 
                           dat = "dat_tmp1", 
                           mets_info = "hilic_pos_mets_info", 
                           add_covar = " + bmi")
res_5_5_2[tentative_annotation != "Unknown" & pval < alpha_thld/5, .N, 
          feature %in% res_overall[tentative_annotation != "Unknown" & pval < alpha_thld/5, feature]]
res_5_5_2 <- res_5_5_2[, subgroup := "bmi_low_30"] %>% setcolorder(., "subgroup")


## Association with ICS # prescription in asthmatics

dat_tmp2 <- hilic_pos_dat_excl[asthma_num == 1 & bmi < 30, ]
res_5_5_2_ics <- linreg_res_fnc(expo = "ics_trim_totnum_1y", 
                                mets_list = feat_list, 
                                dat = "dat_tmp2", 
                                mets_info = "hilic_pos_mets_info", 
                                add_covar = " + Gender + bmi")
res_bmi_low <- merge(res_5_5_2, 
                     res_5_5_2_ics[, .(feature, expo_linreg, beta_linreg, pval_linreg, fdr_bh_linreg)], 
                     by = "feature")


## Save results

saveRDS(res_bmi_low, file = here(res_dir, "res_bmi_low_hilic_pos.rds"))

```

## 5.6. Subgroup by OCS use in 1 year before collection
### 5.6.1. OCS # prescription > 0

```{r, eval = F}

## Asthmatics vs controls

dat_tmp1 <- hilic_pos_dat_excl[Stratum %in% hilic_pos_dat_excl[asthma_num == 1 & ocs_trim_totnum_1y > 0, Stratum], ]
res_5_6_1 <- clogi_res_fnc(outc = "asthma_num", 
                           mets_list = feat_list, 
                           dat = "dat_tmp1", 
                           mets_info = "hilic_pos_mets_info", 
                           add_covar = " + bmi")
res_5_6_1[tentative_annotation != "Unknown" & pval < alpha_thld/5, .N, 
          feature %in% res_overall[tentative_annotation != "Unknown" & pval < alpha_thld/5, feature]]
res_5_6_1 <- res_5_6_1[, subgroup := "ocs_1y_prior_yes"] %>% setcolorder(., "subgroup")


## Association with ics # prescription in asthmatics

dat_tmp2 <- hilic_pos_dat_excl[ocs_trim_totnum_1y > 0 & asthma_num == 1, ]
res_5_6_1_ics <- linreg_res_fnc(expo = "ics_trim_totnum_1y", 
                                mets_list = feat_list, 
                                dat = "dat_tmp2", 
                                mets_info = "hilic_pos_mets_info", 
                                add_covar = " + Gender + bmi")
res_ocs_1y_y <- merge(res_5_6_1, 
                      res_5_6_1_ics[, .(feature, expo_linreg, beta_linreg, pval_linreg, fdr_bh_linreg)], 
                      by = "feature")


## Save results

saveRDS(res_ocs_1y_y, file = here(res_dir, "res_ocs_1y_y_hilic_pos.rds"))

```

### 5.6.2. OCS # prescription == 0

```{r, eval = F}

## Asthmatocs vs controls

dat_tmp1 <- hilic_pos_dat_excl[Stratum %in% hilic_pos_dat_excl[asthma_num == 1 & ocs_trim_totnum_1y == 0, Stratum], ]
res_5_6_2 <- clogi_res_fnc(outc = "asthma_num", 
                           mets_list = feat_list, 
                           dat = "dat_tmp1", 
                           mets_info = "hilic_pos_mets_info", 
                           add_covar = " + bmi")
res_5_6_2[tentative_annotation != "Unknown" & pval < alpha_thld/5, .N, 
          feature %in% res_overall[tentative_annotation != "Unknown" & pval < alpha_thld/5, feature]]
res_5_6_2 <- res_5_6_2[, subgroup := "ocs_1y_prior_no"] %>% setcolorder(., "subgroup")
datatable(res_5_6_2[tentative_annotation != "Unknown", ], filter = "top") %>%
        formatSignif(columns = num_cols, digits = sig_digits)


## Association with ocs # prescription in asthmatocs

dat_tmp2 <- hilic_pos_dat_excl[ocs_trim_totnum_1y == 0 & asthma_num == 1, ]
res_5_6_2_ics <- linreg_res_fnc(expo = "ics_trim_totnum_1y", 
                                mets_list = feat_list, 
                                dat = "dat_tmp2", 
                                mets_info = "hilic_pos_mets_info", 
                                add_covar = " + Gender + bmi")
res_ocs_1y_n <- merge(res_5_6_2, 
                      res_5_6_2_ics[, .(feature, expo_linreg, beta_linreg, pval_linreg, fdr_bh_linreg)], 
                      by = "feature")


## Save results

saveRDS(res_ocs_1y_n, file = here(res_dir, "res_ocs_1y_n_hilic_pos.rds"))

```

## 5.7. Subgroup by IgE/allergy status
### 5.7.1. High total/specific IgE or environmental allergy

```{r}


## Asthmatics vs controls

dat_tmp1 <- hilic_pos_dat_excl[Stratum %in% hilic_pos_dat_excl[asthma_num == 1 & allergy_ever == 1, Stratum], ]
res_5_7_1 <- clogi_res_fnc(outc = "asthma_num", 
                           mets_list = feat_list, 
                           dat = "dat_tmp1", 
                           mets_info = "hilic_pos_mets_info", 
                           add_covar = " + bmi")
res_5_7_1[tentative_annotation != "Unknown" & pval < alpha_thld/5, .N, 
          feature %in% res_overall[tentative_annotation != "Unknown" & pval < alpha_thld/5, feature]]
res_5_7_1 <- res_5_7_1[, subgroup := "ige_high_env_allergy"] %>% setcolorder(., "subgroup")


## Association with ICS # prescription in asthmatics

dat_tmp2 <- hilic_pos_dat_excl[asthma_num == 1 & allergy_ever == 1, ]
res_5_7_1_ics <- linreg_res_fnc(expo = "ics_trim_totnum_1y", 
                                mets_list = feat_list, 
                                dat = "dat_tmp2", 
                                mets_info = "hilic_pos_mets_info", 
                                add_covar = " + Gender + bmi")
res_ige_high <- merge(res_5_7_1, 
                      res_5_7_1_ics[, .(feature, expo_linreg, beta_linreg, pval_linreg, fdr_bh_linreg)], 
                      by = "feature")


## Save results

saveRDS(res_ige_high, file = here(res_dir, "res_allergy_y_hilic_pos.rds"))

```

### 5.7.2. Normal total/specific IgE and no environmental allergy

```{r}

## Asthmatics vs controls

dat_tmp1 <- hilic_pos_dat_excl[Stratum %in% hilic_pos_dat_excl[asthma_num == 1 & allergy_ever == 0, Stratum], ]
res_5_7_2 <- clogi_res_fnc(outc = "asthma_num", 
                           mets_list = feat_list, 
                           dat = "dat_tmp1", 
                           mets_info = "hilic_pos_mets_info", 
                           add_covar = " + bmi")
res_5_7_2[tentative_annotation != "Unknown" & pval < alpha_thld/5, .N, 
          feature %in% res_overall[tentative_annotation != "Unknown" & pval < alpha_thld/5, feature]]
res_5_7_2 <- res_5_7_2[, subgroup := "ige_norm_no_env_allergy"] %>% setcolorder(., "subgroup")


## Association with ICS # prescription in asthmatics

dat_tmp2 <- hilic_pos_dat_excl[asthma_num == 1 & allergy_ever == 0, ]
res_5_7_2_ics <- linreg_res_fnc(expo = "ics_trim_totnum_1y", 
                                mets_list = feat_list, 
                                dat = "dat_tmp2", 
                                mets_info = "hilic_pos_mets_info", 
                                add_covar = " + Gender + bmi")
res_ige_norm <- merge(res_5_7_2, 
                      res_5_7_2_ics[, .(feature, expo_linreg, beta_linreg, pval_linreg, fdr_bh_linreg)], 
                      by = "feature")


## Save results

saveRDS(res_ige_norm, file = here(res_dir, "res_allergy_n_hilic_pos.rds"))

```

## 5.8. Subgroup by neutrophil
### 5.8.1. NEUT >= median

```{r}

neut_median <- median(hilic_pos_dat_excl$neut, na.rm = T)
neut_median


## Asthmatics vs controls

dat_tmp1 <- hilic_pos_dat_excl[Stratum %in% hilic_pos_dat_excl[asthma_num == 1 & neut >= neut_median, Stratum], ]
res_5_8_1 <- clogi_res_fnc(outc = "asthma_num", 
                           mets_list = feat_list, 
                           dat = "dat_tmp1", 
                           mets_info = "hilic_pos_mets_info", 
                           add_covar = " + bmi")
res_5_8_1[tentative_annotation != "Unknown" & pval < alpha_thld/5, .N, 
          feature %in% res_overall[tentative_annotation != "Unknown" & pval < alpha_thld/5, feature]]
res_5_8_1 <- res_5_8_1[, subgroup := "neut_high_median"] %>% setcolorder(., "subgroup")


## Association with ICS # prescription in asthmatics

dat_tmp2 <- hilic_pos_dat_excl[asthma_num == 1 & neut >= neut_median, ]
res_5_8_1_ics <- linreg_res_fnc(expo = "ics_trim_totnum_1y", 
                                mets_list = feat_list, 
                                dat = "dat_tmp2", 
                                mets_info = "hilic_pos_mets_info", 
                                add_covar = " + Gender + bmi")
res_neut_high <- merge(res_5_8_1, 
                      res_5_8_1_ics[, .(feature, expo_linreg, beta_linreg, pval_linreg, fdr_bh_linreg)], 
                      by = "feature")


## Save results

saveRDS(res_neut_high, file = here(res_dir, "res_neut_high_hilic_pos.rds"))

```

### 5.8.2. NEUT < median

```{r}

## Asthmatics vs controls

dat_tmp1 <- hilic_pos_dat_excl[Stratum %in% hilic_pos_dat_excl[asthma_num == 1 & neut < neut_median, Stratum], ]
res_5_8_2 <- clogi_res_fnc(outc = "asthma_num", 
                           mets_list = feat_list, 
                           dat = "dat_tmp1", 
                           mets_info = "hilic_pos_mets_info", 
                           add_covar = " + bmi")
res_5_8_2[tentative_annotation != "Unknown" & pval < alpha_thld/5, .N, 
          feature %in% res_overall[tentative_annotation != "Unknown" & pval < alpha_thld/5, feature]]
res_5_8_2 <- res_5_8_2[, subgroup := "neut_low_median"] %>% setcolorder(., "subgroup")


## Association with ICS # prescription in asthmatics

dat_tmp2 <- hilic_pos_dat_excl[asthma_num == 1 & neut < neut_median, ]
res_5_8_2_ics <- linreg_res_fnc(expo = "ics_trim_totnum_1y", 
                                mets_list = feat_list, 
                                dat = "dat_tmp2", 
                                mets_info = "hilic_pos_mets_info", 
                                add_covar = " + Gender + bmi")
res_neut_low <- merge(res_5_8_2, 
                     res_5_8_2_ics[, .(feature, expo_linreg, beta_linreg, pval_linreg, fdr_bh_linreg)], 
                     by = "feature")


## Save results

saveRDS(res_neut_low, file = here(res_dir, "res_neut_low_hilic_pos.rds"))

```

# 6. Within asthmatics comparisons

```{r}

logi_res_fnc <- function(outc, mets_list, dat, mets_info, add_covar = "", 
                         first_cols = c("feature", "beta", "pval", "tentative_annotation", "wo_ms2", 
                                        "med_feat", "rt_min", "mz", "platform", "cv", "pct_na_met"), 
                         na_thld = missing_thld) {
        
        logi_mdl_tmp <- function(met) {
                
                fit <- eval(parse(text = str_c("glm(", outc, " ~ ", met, " + Age + race", 
                                               add_covar, ", data = ", dat, ", family = 'binomial')")))
                
                coef <- summary(fit)$coefficients
                coef <- coef[rownames(coef) == met, ]
                
                output <- t(c(outc, met, coef)) %>% as.data.table()
                colnames(output) <- c("outc", "feature", "beta", "se", "zval", "pval")
                output[, (colnames(output)[-c(1:2)]) := lapply(.SD, as.numeric), .SDcols = colnames(output)[-c(1:2)]]
                
                return(output)
        }
        
        res <- lapply(mets_list, function(x) {logi_mdl_tmp(met = x)}) %>% rbindlist()
        
        eval(parse(text = str_c("mets_info <- copy(", mets_info, ")")))
        res <- merge(res, 
                     mets_info[, .(feature, rt_min, mz, tentative_annotation, wo_ms2, med_feat, 
                                   platform, cv, pct_na_met, skewness_post)], 
                     by = "feature")
        # res[pct_na_met <= na_thld & feature != "Unknown", fdr_bh := p.adjust(pval, method = "BH")] 
        res[, ':='(or = exp(beta), 
                   lower95 = exp(beta - z_95 * se), 
                   upper95 = exp(beta + z_95 * se))] 
        
        setcolorder(res, first_cols)
        res <- res[order(pval)]
        return(res)
}

linear_res_fnc <- function(expo, mets_list, dat, mets_info, add_covar = "", 
                           first_cols = c("feature", "expo", "beta", "pval", "tentative_annotation", 
                                          "wo_ms2", "med_feat", "rt_min", "mz", "platform", "cv", "pct_na_met"), 
                           na_thld = missing_thld) {
        
        linear_mdl_tmp <- function(met) {
                
                fit <- eval(parse(text = str_c("lm(", met, " ~ ", expo, " + Age + race", 
                                               add_covar, ", data = ", dat, ")")))
                
                coef <- summary(fit)$coefficients
                coef <- coef[rownames(coef) == expo, ]

                output <- t(c(expo, met, coef)) %>% as.data.table()
                colnames(output) <- c("expo", "feature", "beta", "se", "tval", "pval")
                output[, (colnames(output)[-c(1:2)]) := lapply(.SD, as.numeric), .SDcols = colnames(output)[-c(1:2)]]
                
                return(output)
        }
        
        res <- lapply(mets_list, function(x) {linear_mdl_tmp(met = x)}) %>% rbindlist()
        
        eval(parse(text = str_c("mets_info <- copy(", mets_info, ")")))
        res <- merge(res, 
                     mets_info[, .(feature, rt_min, mz, tentative_annotation, wo_ms2, med_feat, 
                                   platform, cv, pct_na_met, skewness_post)], 
                     by = "feature")

        setcolorder(res, first_cols)
        res <- res[order(pval)]
        return(res)
}

hilic_pos_dat_excl[asthma_num == 1, eos_high := case_when(eos >= 0.3 ~ 1, 
                                                          eos < 0.3 ~ 0)]
hilic_pos_dat_excl[asthma_num == 1, obese := case_when(bmi >= 30 ~ 1, 
                                                       bmi < 30 ~ 0)]
hilic_pos_dat_excl[, female := case_when(Gender == "F" ~ 1, 
                                       Gender == "M" ~ 0)]
hilic_pos_dat_asthma <- hilic_pos_dat_excl[asthma_num == 1, ]

```

## 6.1. High vs low eosinophilic

```{r}

hilic_pos_dat_asthma[, .N, eos_high]
res_high_vs_low_eos <- logi_res_fnc(outc = "eos_high", 
                                    mets_list = feat_list, 
                                    dat = "hilic_pos_dat_asthma", 
                                    mets_info = "hilic_pos_mets_info", 
                                    add_covar = " + Gender + bmi")

res_high_vs_low_eos[tentative_annotation != "Unknown" & pval < alpha_thld/5, .N, 
                    feature %in% res_overall[tentative_annotation != "Unknown" & pval < alpha_thld/5, feature]]
res_high_vs_low_eos <- res_high_vs_low_eos[, comparison := "high_vs_low_eos_asthmatics"] %>% 
        setcolorder(., "comparison")

```

## 6.2. Obese vs not

```{r}

hilic_pos_dat_asthma[, .N, obese]
res_obese_vs_not <- logi_res_fnc(outc = "obese", 
                                 mets_list = feat_list, 
                                 dat = "hilic_pos_dat_asthma", 
                                 mets_info = "hilic_pos_mets_info", 
                                 add_covar = " + Gender + bmi")

res_obese_vs_not[tentative_annotation != "Unknown" & pval < alpha_thld/5, .N, 
                 feature %in% res_overall[tentative_annotation != "Unknown" & pval < alpha_thld/5, feature]]
res_obese_vs_not <- res_obese_vs_not[, comparison := "obese_vs_not_asthmatics"] %>% 
        setcolorder(., "comparison")

res_compare_asthmatics <- rbind(res_high_vs_low_eos, res_obese_vs_not)

```

## 6.3. high IgE/environmental allergy vs not

```{r}

hilic_pos_dat_asthma[, .N, allergy_ever]
res_allergy_vs_not <- logi_res_fnc(outc = "allergy_ever", 
                               mets_list = feat_list, 
                               dat = "hilic_pos_dat_asthma", 
                               mets_info = "hilic_pos_mets_info", 
                               add_covar = " + Gender + bmi")

res_allergy_vs_not[tentative_annotation != "Unknown" & pval < alpha_thld/5, .N, 
                   feature %in% res_overall[tentative_annotation != "Unknown" & pval < alpha_thld/5, feature]]
res_allergy_vs_not <- res_allergy_vs_not[, comparison := "allergy_vs_not_asthmatics"] %>% 
        setcolorder(., "comparison")

res_compare_asthmatics <- rbind(res_compare_asthmatics, res_allergy_vs_not)

```

## 6.4. Female vs male

```{r}

hilic_pos_dat_asthma[, .N, female]
res_female_vs_male <- logi_res_fnc(outc = "female", 
                                   mets_list = feat_list, 
                                   dat = "hilic_pos_dat_asthma", 
                                   mets_info = "hilic_pos_mets_info", 
                                   add_covar = " + bmi")

res_female_vs_male[tentative_annotation != "Unknown" & pval < alpha_thld/5, .N, 
                   feature %in% res_overall[tentative_annotation != "Unknown" & pval < alpha_thld/5, feature]]
res_female_vs_male <- res_female_vs_male[, comparison := "female_vs_male_asthmatics"] %>% 
        setcolorder(., "comparison")


## In control subjects only 

hilic_pos_dat_ctrl <- hilic_pos_dat_excl[asthma_num == 0, ]

res_female_vs_male_ctrl <- logi_res_fnc(outc = "female", 
                                        mets_list = feat_list, 
                                        dat = "hilic_pos_dat_ctrl", 
                                        mets_info = "hilic_pos_mets_info", 
                                        add_covar = " + bmi")

res_female_vs_male_ctrl[tentative_annotation != "Unknown" & pval < alpha_thld/5, .N, 
                        feature %in% res_female_vs_male[tentative_annotation != "Unknown" & pval < alpha_thld/5, feature]]
res_female_vs_male_ctrl <- res_female_vs_male_ctrl[, comparison := "female_vs_male_controls"] %>% 
        setcolorder(., "comparison")

res_compare_asthmatics <- rbind(res_compare_asthmatics, res_female_vs_male)
res_compare_asthmatics <- rbind(res_compare_asthmatics, res_female_vs_male_ctrl)


## Save results

saveRDS(res_compare_asthmatics, file = here(res_dir, "res_compare_dif_asthmatics_hilic_pos.rds"))

```

## 6.5. Continuous eosinophil

```{r}

hilic_pos_dat_asthma[, summary(eos)]
ggplot(hilic_pos_dat_asthma) + geom_histogram(aes(eos), bins = 100)
res_eos_expo_cont <- linear_res_fnc(expo = "eos", 
                                    mets_list = feat_list, 
                                    dat = "hilic_pos_dat_asthma", 
                                    mets_info = "hilic_pos_mets_info", 
                                    add_covar = " + Gender + bmi")
res_eos_expo_cont <- res_eos_expo_cont[, comparison := "eos_continous"] %>% 
        setcolorder(., "comparison")

```

## 6.6. Continuous fev1

```{r}

hilic_pos_dat_asthma[, summary(fev1_prebd_pctpred)]
ggplot(hilic_pos_dat_asthma) + geom_histogram(aes(fev1_prebd_pctpred), bins = 100)
res_fev1_expo_cont <- linear_res_fnc(expo = "fev1_prebd_pctpred", 
                                     mets_list = feat_list, 
                                     dat = "hilic_pos_dat_asthma", 
                                     mets_info = "hilic_pos_mets_info", 
                                     add_covar = " + Gender + bmi")
res_fev1_expo_cont <- res_fev1_expo_cont[, comparison := "fev1_continous"] %>% 
        setcolorder(., "comparison")

res_qt_asthmatics <- rbind(res_eos_expo_cont, res_fev1_expo_cont)

```

## 6.7. Continuous fvc

```{r}

hilic_pos_dat_asthma[, summary(fvc_prebd_pctpred)]
ggplot(hilic_pos_dat_asthma) + geom_histogram(aes(fvc_prebd_pctpred), bins = 100)
res_fvc_expo_cont <- linear_res_fnc(expo = "fvc_prebd_pctpred", 
                                    mets_list = feat_list, 
                                    dat = "hilic_pos_dat_asthma", 
                                    mets_info = "hilic_pos_mets_info", 
                                    add_covar = " + Gender + bmi")
res_fvc_expo_cont <- res_fvc_expo_cont[, comparison := "fvc_continous"] %>% 
        setcolorder(., "comparison")

res_qt_asthmatics <- rbind(res_qt_asthmatics, res_fvc_expo_cont)

```

## 6.8. Continuous fev1/fvc

```{r}

hilic_pos_dat_asthma[, summary(fev1fvc_prebd_pctpred)]
ggplot(hilic_pos_dat_asthma) + geom_histogram(aes(fev1fvc_prebd_pctpred), bins = 100)
res_fev1fvc_expo_cont <- linear_res_fnc(expo = "fev1fvc_prebd_pctpred", 
                                        mets_list = feat_list, 
                                        dat = "hilic_pos_dat_asthma", 
                                        mets_info = "hilic_pos_mets_info", 
                                        add_covar = " + Gender + bmi")
res_fev1fvc_expo_cont <- res_fev1fvc_expo_cont[, comparison := "fev1fvc_continous"] %>% 
        setcolorder(., "comparison")

res_qt_asthmatics <- rbind(res_qt_asthmatics, res_fev1fvc_expo_cont)

```

## 6.9. Continuous neutrophil

```{r}

hilic_pos_dat_asthma[, summary(neut)]
ggplot(hilic_pos_dat_asthma) + geom_histogram(aes(neut), bins = 100)
res_neut_expo_cont <- linear_res_fnc(expo = "neut", 
                                     mets_list = feat_list, 
                                     dat = "hilic_pos_dat_asthma", 
                                     mets_info = "hilic_pos_mets_info", 
                                     add_covar = " + Gender + bmi")
res_neut_expo_cont <- res_neut_expo_cont[, comparison := "neut_continous"] %>% 
        setcolorder(., "comparison")

res_qt_asthmatics <- rbind(res_qt_asthmatics, res_neut_expo_cont)


## Save results

saveRDS(res_qt_asthmatics, file = here(res_dir, "res_qt_asthmatics_hilic_pos.rds"))

```

## 6.10. Cortisol (F1381) & ICS

```{r}

hilic_pos_dat[Asthma_Status == T, summary(ics_trim_totnum_1y)]
hilic_pos_dat[Asthma_Status == T, .N, .(is.na(fev1_prebd_pctpred), is.na(fvc_prebd_pctpred), 
                                        is.na(fev1fvc_prebd_pctpred))]

cort_dat <- hilic_pos_dat[Asthma_Status == T, ]
for (y in c("", "_1y", "_2y", "_3y", "_5y", "_10y")) {
        eval(parse(text = str_c("cort_dat[, ':='(ics_trim_totnum", y, "_gt0 = ifelse(ics_trim_totnum", y, " > 0, 1, 0), 
                                                 ics_trim_totnum", y, "_gt1 = ifelse(ics_trim_totnum", y, " > 1, 1, 0), 
                                                 ics_trim_totnum", y, "_gt2 = ifelse(ics_trim_totnum", y, " > 2, 1, 0), 
                                                 ics_trim_totnum", y, "_gt3 = ifelse(ics_trim_totnum", y, " > 3, 1, 0), 
                                                 ics_trim_totnum", y, "_gt4 = ifelse(ics_trim_totnum", y, " > 4, 1, 0), 
                                                 ics_trim_totnum", y, "_gt5 = ifelse(ics_trim_totnum", y, " > 5, 1, 0), 
                                                 ics_trim_totnum", y, "_gt6 = ifelse(ics_trim_totnum", y, " > 6, 1, 0), 
                                                 ics_trim_totnum", y, "_gt7 = ifelse(ics_trim_totnum", y, " > 7, 1, 0), 
                                                 ics_trim_totnum", y, "_gt8 = ifelse(ics_trim_totnum", y, " > 8, 1, 0), 
                                                 ics_trim_totnum", y, "_gt9 = ifelse(ics_trim_totnum", y, " > 9, 1, 0))]")))
}

suf_list <- cross(list(c("", "_1y", "_2y", "_3y", "_5y", "_10y"), 
                       c("", str_c("_gt", c(0:9))))) %>% 
        map_chr(paste, sep = "", collapse = "")

cort_dat[!is.na(fev1_prebd_pctpred), .N, .(ics_trim_totnum_1y>6, ics_trim_totnum_1y_gt6)]
cort_dat[!is.na(fev1_prebd_pctpred), .N, .(ics_trim_totnum_1y>7, ics_trim_totnum_1y_gt7)]
cort_dat[!is.na(fev1_prebd_pctpred), .N, .(ics_trim_totnum_1y>8, ics_trim_totnum_1y_gt8)]
cort_dat[!is.na(fev1_prebd_pctpred), .N, .(ics_trim_totnum_1y>9, ics_trim_totnum_1y_gt9)]

res_ics_cortisol_asthmatics <- NULL
for (y in suf_list) {
        for (lf in c("", " + fev1_prebd_pctpred", " + fvc_prebd_pctpred", " + fev1fvc_prebd_pctpred")) {
                res_tmp <- linear_res_fnc(expo = str_c("ics_trim_totnum", y), 
                                          mets_list = c("F1381"), 
                                          dat = "cort_dat", 
                                          mets_info = "hilic_pos_mets_info", 
                                          add_covar = str_c(" + Gender + bmi", lf))
                res_tmp[, lungfnc_adjust := lf]
                res_ics_cortisol_asthmatics <- rbind(res_ics_cortisol_asthmatics, res_tmp)
        }
}
setcolorder(res_ics_cortisol_asthmatics, c("feature", "tentative_annotation", "expo", "lungfnc_adjust"))
datatable(res_ics_cortisol_asthmatics[pval < alpha_thld, c(1:6)]) %>%
        formatSignif(columns = c("beta", "pval"), digits = 3)

fwrite(res_ics_cortisol_asthmatics, file = here(res_dir, "results_ics_cortisol_asthmatics.csv"))

```

# Session info

```{r}

sessionInfo()

```
